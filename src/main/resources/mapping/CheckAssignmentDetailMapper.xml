<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cit.dmt.core.dao.CheckAssignmentDetailMapper">
  <resultMap id="BaseResultMap" type="com.cit.dmt.core.model.CheckAssignmentDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    <id column="t_id" jdbcType="BIGINT" property="id" />
    <result column="t_round_id" jdbcType="BIGINT" property="roundId" />
    <result column="t_project_id" jdbcType="BIGINT" property="projectId" />
    <result column="t_task_id" jdbcType="BIGINT" property="taskId" />
    <result column="t_user_id" jdbcType="BIGINT" property="userId" />
    <result column="t_task_detail_id" jdbcType="BIGINT" property="taskDetailId" />
    <result column="t_check_status" jdbcType="CHAR" property="checkStatus" />
    <result column="t_check_result" jdbcType="VARCHAR" property="checkResult" />
    <result column="t_check_memo" jdbcType="VARCHAR" property="checkMemo" />
    <result column="t_adoption_status" jdbcType="CHAR" property="adoptionStatus" />
  </resultMap>
  <resultMap id="AssignmentStsResultMap" type="com.cit.dmt.core.model.CheckRoundAssignmentSts">
    <result column="total" jdbcType="INTEGER" property="total" />
    <result column="unassigned" jdbcType="INTEGER" property="unassigned" />
    <result column="assigned" jdbcType="INTEGER" property="assigned" />
    <result column="waitingCheck" jdbcType="INTEGER" property="waitingCheck" />
    <result column="checked" jdbcType="INTEGER" property="checked" />
    <result column="waitingAdoption" jdbcType="INTEGER" property="waitingAdoption" />
    <result column="adopted" jdbcType="INTEGER" property="adopted" />
    <result column="rejected" jdbcType="INTEGER" property="rejected" />
  </resultMap>
  <resultMap id="FinalTransResultMap" type="com.cit.dmt.core.model.FinalTrans" extends="BaseResultMap">
    <result column="td_original" jdbcType="VARCHAR" property="original" />
    <result column="td_country" jdbcType="VARCHAR" property="country" />
    <result column="td_language" jdbcType="VARCHAR" property="language" />
    <result column="td_gec" jdbcType="VARCHAR" property="gec" />
    <result column="td_memo" jdbcType="VARCHAR" property="memo" />
    <result column="td_roman_status" jdbcType="CHAR" property="romanStatus" />
    <result column="td_roman" jdbcType="VARCHAR" property="roman" />
    <result column="td_trans_status" jdbcType="CHAR" property="transStatus" />
    <result column="td_transliteration" jdbcType="VARCHAR" property="transliteration" />
    <result column="td_free_translation" jdbcType="VARCHAR" property="freeTranslation" />
  </resultMap>
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    t.id as t_id, t.round_id as t_round_id, t.project_id as t_project_id, t.task_id as t_task_id, 
    t.user_id as t_user_id, t.task_detail_id as t_task_detail_id, t.check_status as t_check_status, 
    t.check_result as t_check_result, t.check_memo as t_check_memo, t.adoption_status as t_adoption_status
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="FinalTransResultMap">
    select 
    <include refid="Base_Column_List" />,
    <include refid="Task_Detail_Column_List" />
    from check_assignment_detail t
      join task_detail td on
        td.id = t.task_detail_id
    where t.id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    delete from check_assignment_detail
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.cit.dmt.core.model.CheckAssignmentDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    insert into check_assignment_detail (id, round_id, project_id, 
      task_id, user_id, task_detail_id, 
      check_status, check_result, check_memo, 
      adoption_status)
    values (#{id,jdbcType=BIGINT}, #{roundId,jdbcType=BIGINT}, #{projectId,jdbcType=BIGINT}, 
      #{taskId,jdbcType=BIGINT}, #{userId,jdbcType=BIGINT}, #{taskDetailId,jdbcType=BIGINT}, 
      #{checkStatus,jdbcType=CHAR}, #{checkResult,jdbcType=VARCHAR}, #{checkMemo,jdbcType=VARCHAR}, 
      #{adoptionStatus,jdbcType=CHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.cit.dmt.core.model.CheckAssignmentDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    insert into check_assignment_detail
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="roundId != null">
        round_id,
      </if>
      <if test="projectId != null">
        project_id,
      </if>
      <if test="taskId != null">
        task_id,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="taskDetailId != null">
        task_detail_id,
      </if>
      <if test="checkStatus != null">
        check_status,
      </if>
      <if test="checkResult != null">
        check_result,
      </if>
      <if test="checkMemo != null">
        check_memo,
      </if>
      <if test="adoptionStatus != null">
        adoption_status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="roundId != null">
        #{roundId,jdbcType=BIGINT},
      </if>
      <if test="projectId != null">
        #{projectId,jdbcType=BIGINT},
      </if>
      <if test="taskId != null">
        #{taskId,jdbcType=BIGINT},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=BIGINT},
      </if>
      <if test="taskDetailId != null">
        #{taskDetailId,jdbcType=BIGINT},
      </if>
      <if test="checkStatus != null">
        #{checkStatus,jdbcType=CHAR},
      </if>
      <if test="checkResult != null">
        #{checkResult,jdbcType=VARCHAR},
      </if>
      <if test="checkMemo != null">
        #{checkMemo,jdbcType=VARCHAR},
      </if>
      <if test="adoptionStatus != null">
        #{adoptionStatus,jdbcType=CHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.cit.dmt.core.model.CheckAssignmentDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    update check_assignment_detail
    <set>
      <if test="roundId != null">
        round_id = #{roundId,jdbcType=BIGINT},
      </if>
      <if test="projectId != null">
        project_id = #{projectId,jdbcType=BIGINT},
      </if>
      <if test="taskId != null">
        task_id = #{taskId,jdbcType=BIGINT},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="taskDetailId != null">
        task_detail_id = #{taskDetailId,jdbcType=BIGINT},
      </if>
      <if test="checkStatus != null">
        check_status = #{checkStatus,jdbcType=CHAR},
      </if>
      <if test="checkResult != null">
        check_result = #{checkResult,jdbcType=VARCHAR},
      </if>
      <if test="checkMemo != null">
        check_memo = #{checkMemo,jdbcType=VARCHAR},
      </if>
      <if test="adoptionStatus != null">
        adoption_status = #{adoptionStatus,jdbcType=CHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.cit.dmt.core.model.CheckAssignmentDetail">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Jul 04 13:35:32 NZST 2021.
    -->
    update check_assignment_detail
    set round_id = #{roundId,jdbcType=BIGINT},
      project_id = #{projectId,jdbcType=BIGINT},
      task_id = #{taskId,jdbcType=BIGINT},
      user_id = #{userId,jdbcType=BIGINT},
      task_detail_id = #{taskDetailId,jdbcType=BIGINT},
      check_status = #{checkStatus,jdbcType=CHAR},
      check_result = #{checkResult,jdbcType=VARCHAR},
      check_memo = #{checkMemo,jdbcType=VARCHAR},
      adoption_status = #{adoptionStatus,jdbcType=CHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <sql id="Task_Detail_Column_List">
    td.original as td_original, 
    td.country as td_country, td.language as td_language, td.gec as td_gec, td.memo as td_memo, 
    td.roman_status as td_roman_status, td.roman as td_roman, td.trans_status as td_trans_status, 
    td.transliteration as td_transliteration, td.free_translation as td_free_translation
  </sql>
  <select id="selectPaged" parameterType="java.util.HashMap" resultMap="FinalTransResultMap">
    select
    <include refid="Base_Column_List" />,
    <include refid="Task_Detail_Column_List" />
    from check_assignment_detail t
      join task_detail td on
        td.id = t.task_detail_id
    where 1=1
    <if test="projectId != null">
      and t.project_id = #{projectId,jdbcType=BIGINT}
    </if>
    <if test="taskId != null">
      and t.task_id = #{taskId,jdbcType=BIGINT}
    </if>
    <if test="roundId != null">
      and t.round_id = #{roundId,jdbcType=BIGINT}
    </if>
    <if test="userId != null">
      and t.user_id = #{userId,jdbcType=BIGINT}
    </if>
    <if test="checkStatus != null">
      and t.check_status = #{checkStatus,jdbcType=CHAR}
    </if>
    <if test="adoptionStatus != null">
      and t.adoption_status = #{adoptionStatus,jdbcType=CHAR}
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <insert id="insertAllTask" parameterType="java.util.HashMap">
    insert into check_assignment_detail(project_id, task_id, round_id, user_id, task_detail_id, check_status, adoption_status)
    select t.project_id, t.task_id, #{roundId,jdbcType=BIGINT}, -1, t.id, '0', '0'
    from task_detail t
    where t.project_id = #{projectId,jdbcType=BIGINT} 
      and t.task_id = #{taskId,jdbcType=BIGINT}
  </insert>
  <select id="getTaskCount" parameterType="java.util.HashMap" resultMap="AssignmentStsResultMap">
    select count(t.id) as total,
      sum(if(t.user_id = -1, 1, 0)) as unassigned,
      sum(if(t.user_id = -1, 0, 1)) as assigned,
      sum(if(t.check_status = '0', 1, 0)) as waitingCheck,
      sum(if(t.check_status = '1', 1, 0)) as checked,
      sum(if(t.adoption_status = '0', 1, 0)) as waitingAdoption,
      sum(if(t.adoption_status = '1', 1, 0)) as adopted,
      sum(if(t.adoption_status = '2', 1, 0)) as rejected
    from check_assignment_detail t
    where t.project_id = #{projectId,jdbcType=BIGINT}
      and t.task_id = #{taskId,jdbcType=BIGINT}
      and t.round_id = #{roundId,jdbcType=BIGINT}
    <if test="userId != null">
      and t.user_id = #{userId,jdbcType=BIGINT}
    </if>
  </select>
  <update id="taskAssign" parameterType="java.util.HashMap">
    update check_assignment_detail
    set user_id = #{userId,jdbcType=BIGINT}
    where project_id = #{projectId,jdbcType=BIGINT}
      and task_id = #{taskId,jdbcType=BIGINT}
      and round_id = #{roundId,jdbcType=BIGINT}
      and user_id = -1
    limit #{assignAmount,jdbcType=INTEGER}
  </update>
  <update id="withdrawAssign">
    update check_assignment_detail
    set user_id = -1
    where project_id = #{projectId,jdbcType=BIGINT}
      and task_id = #{taskId,jdbcType=BIGINT}
      and round_id = #{roundId,jdbcType=BIGINT}
      and user_id = #{userId,jdbcType=BIGINT}
    <if test="checkStatus != null">
      and check_status = #{checkStatus,jdbcType=CHAR}
    </if>
    limit #{withdrawAmount,jdbcType=INTEGER}
  </update>
  <update id="updateCheckResult">
    update check_assignment_detail
    set check_status = '1',
      check_result = #{checkResult,jdbcType=VARCHAR},
      check_memo = #{checkMemo,jdbcType=VARCHAR},
      adoption_status = '0'
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateAdoptionById">
    update check_assignment_detail
    set adoption_status = #{adoptionStatus,jdbcType=CHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateAdoptionAll">
    update check_assignment_detail
    set adoption_status = #{adoptionStatus,jdbcType=CHAR}
    where check_status = '1'
      and project_id = #{projectId,jdbcType=BIGINT}
      and task_id = #{taskId,jdbcType=BIGINT}
      and round_id = #{roundId,jdbcType=BIGINT}
    <if test="userId != null">
      and user_id = #{userId,jdbcType=BIGINT}
    </if>
  </update>
</mapper>